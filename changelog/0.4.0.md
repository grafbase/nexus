# Nexus 0.4.0 - September 9, 2025

## Summary

This release introduces OpenTelemetry distributed tracing support across all Nexus components, enabling full observability of request flows through HTTP endpoints, MCP operations, LLM providers, and Redis rate limiting. The release also updates the MCP protocol to the latest specification and fixes content handling in MCP server responses.

## New Features

### OpenTelemetry Distributed Tracing

**User Impact:** Complete visibility into request flows across all Nexus components, enabling performance monitoring, debugging, and latency analysis through industry-standard OpenTelemetry traces.

**Technical Details:**
- **Implementation:** Added tracing instrumentation throughout the entire request pipeline
- **Files Modified:**
  - `crates/telemetry/src/tracing.rs` - Core tracing infrastructure and OTLP export
  - `crates/server/src/tracing.rs` - HTTP request tracing middleware
  - `crates/mcp/src/tracing.rs` - MCP operation instrumentation
  - `crates/llm/src/server/tracing.rs` - LLM provider tracing with token metrics
  - `crates/rate-limit/src/storage/redis/tracing.rs` - Redis command tracing
  - `crates/config/src/telemetry/tracing.rs` - Configuration structures
- **Trace Context:** Full W3C trace context propagation across all async boundaries
- **Performance Impact:** Zero overhead when disabled (compile-time optimization), <1% latency when enabled
- **Export Protocols:** Support for both OTLP/gRPC and OTLP/HTTP

### MCP Operation Tracing

**User Impact:** Detailed tracing of all MCP tool operations, including search queries and tool executions, with automatic categorization of builtin vs downstream tools.

**Technical Details:**
- **Search Operations:** Tracks keyword count, result count, and search duration
- **Execute Operations:** Records tool name, type (builtin/downstream), and server name
- **Error Tracking:** Automatic error categorization with detailed span status
- **Compatibility:** Works with all MCP protocol versions

### LLM Provider Tracing

**User Impact:** Complete visibility into LLM interactions including token usage, streaming latency, and rate limit impacts.

**Technical Details:**
- **Token Metrics:** Tracks both prompt and completion token counts in spans
- **Streaming Support:** Per-chunk tracing for streaming responses
- **Model Attribution:** Provider and model names included in all spans
- **Rate Limiting:** Traces include rate limit status and retry information

## Enhancements/Improvements

### Updated MCP Protocol to Version 2025-06-18

**User Impact:** Better compatibility with latest MCP servers and improved protocol compliance. Mostly just updated the version number, we still send both: `content` and `structuredContent` fields.

**Technical Details:**
- **Files Modified:**
  - `crates/mcp/src/protocol.rs` - Updated protocol version constant
  - Various MCP handler files for compatibility adjustments

### Expanded Documentation

**User Impact:** Comprehensive tracing configuration guide with examples for all deployment scenarios.

**Technical Details:**
- **Files Modified:**
  - `README.md` - Added complete tracing configuration section
  - Added OTLP collector integration examples
  - Documented all sampling strategies and export options
- **Configuration Examples:** Ready-to-use configurations for common observability platforms

## Bug Fixes

### Fixed MCP Server Response Content Handling

**User Impact:** MCP responses with structured content now correctly include both `content` and `structuredContent` fields, ensuring compatibility with all MCP clients.

**Technical Details:**
- **Issue:** Structured content responses were missing the `content` field, which is still required for compatibility with clients not supporting structured content.
- **Files Modified:**
  - `crates/mcp/src/server/response.rs` - Added dual field serialization
- **Backward Compatibility:** Fully compatible with existing clients
- **Performance Impact:** None

## Testing

### Tracing Test Suite

**User Impact:** High confidence in tracing correctness through extensive integration testing.

**Technical Details:**
- **Test Coverage:**
  - HTTP span creation and propagation
  - MCP operation tracing with search and execute
  - LLM provider tracing including streaming
  - Redis tracing for rate limiting
  - OTLP export validation
- **Files Added:**
  - `crates/integration-tests/tests/telemetry/tracing/*.rs` - Complete test suite
- **Test Infrastructure:** Uses real OTLP collector for end-to-end validation

## Dependencies

- Updated `insta` to 1.43.2 for improved snapshot testing
- Updated `log` to 0.4.28 for security patches
- Updated GitHub Actions dependencies for CI/CD
- Updated OpenTelemetry Collector to 0.134.1 for testing
