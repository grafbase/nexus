# Nexus 0.3.5 - September 2, 2025

## Summary

This release introduces observability capabilities through OpenTelemetry metrics integration across all major Nexus components. The telemetry implementation provides detailed insights into MCP operations, LLM interactions, and Redis storage performance with zero overhead when disabled. Additionally, several dependencies have been updated to their latest versions for improved stability and security.

## New Features

### OpenTelemetry Metrics Integration

**User Impact:** Nexus now provides monitoring capabilities through OpenTelemetry metrics export, enabling teams to track system performance, usage patterns, and identify bottlenecks across all operations.

**Technical Details:**
- Implemented OpenTelemetry SDK integration with OTLP export support (gRPC and HTTP protocols)
- Added configurable telemetry settings with service name, resource attributes, and batch export parameters
- Metrics collection via middleware ensures zero performance overhead when telemetry is disabled
- Files modified: `crates/telemetry/src/lib.rs`, `crates/telemetry/src/metrics.rs`, `crates/telemetry/src/metrics/recorder.rs`, `crates/telemetry/src/metrics/names.rs`
- Configuration: New `[telemetry]` section in config with OTLP exporter settings

### MCP Operation Metrics

**User Impact:** Detailed visibility into MCP tool operations including search, execute, and resource access patterns with comprehensive error tracking and client identification.

**Technical Details:**
- Implemented metrics for all MCP operations: `mcp.tool.call.duration`, `mcp.tools.list.duration`, `mcp.prompt.request.duration`, `mcp.resource.request.duration`
- Rich attribute sets including tool names, types (builtin/downstream), client IDs, groups, and detailed error types
- Special attributes for search operations (keyword_count, result_count) and execute operations (server_name)
- Files modified: `crates/mcp/src/server/metrics.rs`, `crates/mcp/src/server/builder.rs`, `crates/mcp/src/server/handler.rs`
- Error categorization follows JSON-RPC error codes with semantic mapping

### LLM Operation Metrics

**User Impact:** Complete observability into LLM interactions including token usage tracking, time-to-first-token measurements for streaming responses, and detailed error categorization.

**Technical Details:**
- Implemented OpenTelemetry semantic conventions for GenAI metrics
- Metrics include: `gen_ai.client.operation.duration`, `gen_ai.client.time_to_first_token`, token usage counters (input/output/total)
- Streaming response metrics with custom stream wrapper for accurate TTFT measurement
- Files modified: `crates/llm/src/server/metrics.rs`, `crates/llm/src/server/metrics/stream.rs`, `crates/llm/src/server/builder.rs`, `crates/llm/src/server/handler.rs`
- Token counting integrated with rate limiting for accurate consumption tracking

### Redis Storage Metrics

**User Impact:** Monitoring capabilities for Redis-based rate limiting operations, providing insights into connection pool usage and command performance.

**Technical Details:**
- Added metrics for Redis operations: `redis.command.duration`, `redis.pool.connections.in_use`, `redis.pool.connections.available`
- Operation-specific attributes for rate limit checking (check_and_consume, check_and_consume_tokens)
- Connection pool gauges for monitoring resource utilization
- Files modified: `crates/rate-limit/src/storage/redis.rs`
- Integration with telemetry recorder for consistent metric collection

## Bug Fixes

### CORS Preflight Requests Now Bypass Authentication

**User Impact:** CORS preflight (OPTIONS) requests no longer require authentication or client ID headers, allowing browser-based applications to properly negotiate cross-origin access before sending authenticated requests.

**Technical Details:**
- Fixed issue where OPTIONS requests were blocked by OAuth2 and client identification middleware
- CORS preflight requests now correctly bypass authentication checks while maintaining security for actual API calls
- Files modified: `crates/server/src/auth.rs`, `crates/server/src/client_id/middleware.rs`
- Tests added: `crates/integration-tests/tests/oauth2/client_id_cors.rs`

## Enhancements/Improvements

### Unified Metrics Attributes

**User Impact:** Consistent attribute naming across all metrics for easier querying and dashboard creation.

**Technical Details:**
- Standardized attribute names: `client.id`, `client.group`, `error.type` across all subsystems
- Aligned with OpenTelemetry semantic conventions where applicable
- Files modified: Various metric implementations across MCP, LLM, and Redis modules

### Telemetry Testing Infrastructure

**User Impact:** Robust testing ensures metrics are accurate and deterministic, preventing regressions in observability features.

**Technical Details:**
- Integration tests for all metric types with deterministic validation
- Test macros enhanced to support telemetry configuration and validation
- Files modified: `crates/integration-test-macros/src/lib.rs`, `crates/integration-tests/src/telemetry.rs`
- New test modules: `crates/integration-tests/tests/telemetry/metrics/mcp.rs`, `metrics/llm.rs`, `metrics/redis.rs`

## Dependency Updates

### Rust Crate Updates
- **deadpool**: Updated to v0.12.3 - Redis connection pool improvements
- **uuid**: Updated to v1.18.1 - Bug fixes and performance improvements
- **rmcp**: Updated to v0.6.1 - MCP protocol enhancements
- **tracing-subscriber**: Updated to v0.3.20 - Logging improvements
- **AWS SDK**: Updated AWS SDK Rust monorepo dependencies - Latest AWS service support

## Deployment Notes

### Configuration Changes
- New optional `[telemetry]` configuration section - no changes required if telemetry is not needed
- Telemetry is disabled by default with zero performance impact
- To enable telemetry, set `telemetry.exporters.otlp.enabled = true` and configure OTLP endpoint

### Monitoring Setup
- Requires OpenTelemetry collector or compatible backend for metrics ingestion
- Supports both gRPC (port 4317) and HTTP (port 4318) OTLP protocols
- Resource attributes can be configured for environment identification

### Breaking Changes
- None - all changes are backward compatible

### Migration Steps
- No migration required - telemetry features are opt-in
- Existing configurations will continue to work without modification

## Performance Impact

- **Zero overhead when disabled**: Telemetry collection only occurs when explicitly enabled
- **Minimal overhead when enabled**: Metrics collected via efficient middleware patterns
- **Batched exports**: Configurable batch settings prevent network overhead
- **Deterministic metrics**: MCP and LLM metrics are deterministic for reliable monitoring

## Notes

This release focuses on observability without changing any core functionality. The telemetry implementation follows OpenTelemetry best practices and semantic conventions, making it compatible with standard monitoring tools and dashboards.
