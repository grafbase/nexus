# Nexus 0.3.6 - September 3, 2025

## Summary

This release addresses a critical compatibility issue with Google's Gemini API when using function calling (tools). The Google API was rejecting requests containing the `additionalProperties` field in JSON Schema tool parameters, causing 400 Bad Request errors. This fix ensures seamless integration with Google's LLM models when using MCP tools.

## Bug Fixes

### Fixed Google Gemini API Tool Parameter Compatibility

**Issue:** Google's Gemini API was rejecting tool function calls that included `additionalProperties` in their JSON Schema parameter definitions, returning 400 Bad Request errors with the message "Request contains an invalid argument."

**Resolution:** Implemented automatic stripping of `additionalProperties` fields from tool parameter schemas before sending them to Google's API. This transformation is applied recursively to handle nested schema structures.

**Technical Details:**
- **Implementation:** Added `strip_additional_properties` function in `crates/llm/src/provider/google/input.rs` that recursively removes the unsupported field from all levels of the JSON Schema
- **Scope:** The transformation only affects requests sent to Google's API; the original tool definitions remain unchanged for other providers
- **Files Modified:** 
  - `crates/llm/src/provider/google/input.rs` - Core fix implementation
  - `crates/integration-tests/src/llms/google.rs` - Enhanced mock validation
  - `crates/integration-tests/tests/llm/google/tools.rs` - Comprehensive test coverage
- **Testing:** Added integration tests that verify:
  - Tools with `additionalProperties` are correctly transformed
  - Google mock properly simulates the API's rejection behavior
  - The fix prevents the 400 Bad Request errors

## Dependencies Updated

### Patch Updates
- **clap**: Updated from 4.5.46 to 4.5.47
  - Command-line argument parsing improvements
  
- **tonic**: Updated from 0.14.1 to 0.14.2
  - gRPC framework patch update with bug fixes

## Deployment Notes

This release contains only bug fixes and dependency updates with no breaking changes. No special deployment considerations are required.

### Verification Steps
1. If using Google Gemini models with function calling, verify that tool invocations now work correctly
2. Check that tools with complex JSON schemas (containing `additionalProperties`) are properly handled
3. Confirm that other LLM providers (OpenAI, Anthropic) continue to work as expected

## Metrics

- **Performance Impact:** Minimal - the schema transformation adds negligible overhead only for Google API requests
- **Compatibility:** Fully backward compatible with existing configurations
- **Test Coverage:** Added 2 new integration test cases specifically for this issue