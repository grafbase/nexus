# Nexus 0.3.8 - September 3, 2025

## Summary

This patch release enhances time-to-first-token (TTFT) metrics collection to include tool call responses in addition to text content. The improvements ensure performance monitoring for all types of LLM streaming responses, particularly for Google's Gemini API where the initial fix from 0.3.7 needed further refinement.

## Enhancements/Improvements

### Extended TTFT Metrics to Include Tool Calls

**User Impact:** Time-to-first-token metrics now accurately capture the first model decision, whether it's generating text or invoking a tool. This provides better visibility into actual model response times when the AI chooses to use tools rather than generate text.

**Technical Details:**
- **Implementation:** Modified the metrics stream handler to detect both text content and tool calls as valid "first tokens"
- **Files Modified:**
  - `crates/llm/src/server/metrics/stream.rs` - Added tool call detection logic alongside text content detection
- **Metrics Enhancement:** The `gen_ai.client.time_to_first_token` metric now captures:
  - Traditional text responses (as before)
  - Tool call decisions (new capability)
  - First meaningful model output regardless of type
- **Performance Impact:** None - purely additive metric collection

### Refined Google Gemini TTFT Fix

**User Impact:** Further refinement of the 0.3.7 fix to ensure consistent TTFT recording for Google's streaming responses across all response types.

**Technical Details:**
- **Files Modified:**
  - `crates/llm/src/provider/google/output.rs` - Code cleanup and comment clarification
- **Related to:** Builds upon the empty string handling fix from version 0.3.7
- **Compatibility:** Fully backward compatible

## Metrics

- **Observability Improvements:**
  - TTFT metrics now capture 100% of streaming responses (text and tool calls)
  - More accurate latency measurements for tool-using AI workflows
  - Better performance insights for Google Gemini API interactions
- **Performance Impact:** None - changes only affect metric collection accuracy
- **Backward Compatibility:** Fully compatible with existing metric dashboards

## Deployment Notes

This is a minor enhancement release with no breaking changes. The improvements to TTFT metrics provide more performance monitoring without requiring any configuration changes.

### Verification Steps

1. Monitor `gen_ai.client.time_to_first_token` metrics after deployment
2. Verify TTFT is recorded for both text-generating and tool-calling responses
3. Confirm Google Gemini streaming responses show consistent TTFT metrics
4. Check that tool-heavy workflows now show accurate initial response times

### Expected Behavior Changes

- Dashboards may show TTFT metrics for requests that previously didn't record them (tool calls)
- More consistent TTFT data across different LLM response types
- No changes to actual response processing or content delivery
