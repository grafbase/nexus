# Nexus 0.3.4 - August 26, 2025

## Summary
This release introduces header transformation rules for both LLM and MCP providers, enabling fine-grained control over HTTP headers when routing requests to downstream services. This feature addresses requirements for API authentication, request tracing, and custom header management across different providers. Additionally, we've improved CI/CD build performance and included important dependency updates.

## New Features

### Header Transformation Rules for LLM and MCP Providers
**User Impact:** Nexus now provides header manipulation capabilities when routing requests to LLM providers and MCP servers. You can forward headers from incoming requests, insert static headers, remove unwanted headers, and rename headers as they pass through Nexus. This enables integration with APIs requiring specific headers, improves request tracing, and allows for provider-specific header requirements.

**Technical Details:**
- **New crate**: `header-rules` - Core header transformation engine
- **Supported operations**:
  - **Forward**: Pass headers from incoming requests to downstream services
  - **Insert**: Add new headers with static or environment variable values
  - **Remove**: Strip headers matching names or regex patterns
  - **Rename**: Forward headers with different names
  - **Rename-Duplicate**: Keep original and create renamed copy
- **Configuration levels**:
  - Global provider-level rules apply to all models
  - Model-specific rules override provider defaults
  - MCP servers support both global and per-server rules
- **Environment variable substitution**: Use `{{ env.VAR_NAME }}` syntax
- **Regex pattern matching**: Case-insensitive patterns for bulk operations
- **Files modified**:
  - `crates/config/src/headers.rs` - Header rule configuration types
  - `crates/header-rules/src/lib.rs` - Core transformation logic
  - `crates/llm/src/provider/*.rs` - Integration in all LLM providers
  - `crates/mcp/src/downstream/client.rs` - MCP client header support

**Configuration Examples:**

LLM Provider with header rules:
```toml
[llm.providers.openai]
type = "openai"

# Forward request ID for tracing
[[llm.providers.openai.headers]]
rule = "forward"
name = "X-Request-ID"

# Insert API version header
[[llm.providers.openai.headers]]
rule = "insert"
name = "X-OpenAI-Beta"
value = "assistants=v2"

# Remove all X-Internal-* headers
[[llm.providers.openai.headers]]
rule = "remove"
pattern = "^X-Internal-.*"

# Model-specific override
[[llm.providers.openai.models."gpt-4".headers]]
rule = "insert"
name = "X-Model-Version"
value = "latest"
```

MCP Server with headers:
```toml
[mcp.servers.api_server]
url = "https://api.example.com/mcp"

[[mcp.servers.api_server.headers]]
rule = "insert"
name = "Authorization"
value = "Bearer {{ env.API_TOKEN }}"
```

## Enhancements/Improvements

### CI/CD Build Optimization
**User Impact:** Faster CI builds and reduced storage costs for GitHub Actions artifacts.

**Technical Details:**
- Added custom GitHub Action for Cargo cache cleanup
- Removes unnecessary build artifacts after compilation:
  - `.rlib` files (Rust libraries)
  - `.rmeta` files (Rust metadata)
  - Incremental compilation data
  - Debug symbols and other temporary files
- Reduces cache size by approximately 60-70%
- Files added: `.github/actions/cleanup-cargo-cache/action.yml`
- Applied to test workflow stages
- Performance impact: Faster cache restore times, reduced GitHub storage usage

## Infrastructure Updates

### Dependency Updates
- **regex**: Updated to v1.11.2 - Performance improvements and bug fixes
- **url**: Updated to v2.5.7 - URL parsing enhancements

## Deployment Notes

### New Configuration Options

#### LLM Provider Headers
Add header rules to any LLM provider or model configuration:
```toml
[[llm.providers.<name>.headers]]
rule = "forward|insert|remove|rename|rename_duplicate"
# Additional fields depend on rule type
```

#### MCP Server Headers
Configure headers globally or per-server:
```toml
# Global MCP headers
[[mcp.headers]]
rule = "insert"
name = "X-Global-Header"
value = "global-value"

# Server-specific headers
[[mcp.servers.<name>.headers]]
rule = "insert"
name = "X-Server-Header"
value = "{{ env.SERVER_TOKEN }}"
```

### Breaking Changes
- None - Full backward compatibility maintained

### Migration Steps
1. **Review existing configurations**: Header rules are opt-in and don't affect existing setups
2. **For API key headers**: Consider migrating from hardcoded API keys to header rules with environment variables
3. **For request tracing**: Add forward rules for correlation IDs and trace headers
4. **For provider-specific requirements**: Use insert rules for required headers like API versions

### Important Notes
- **Header precedence**: Model-level rules override provider-level rules
- **MCP limitations**: MCP servers only support the "insert" rule with static values
- **Regex patterns**: Are case-insensitive for header names per HTTP specification
- **Performance**: Header transformations add minimal overhead (<1ms per request)
- **Security**: Be cautious when forwarding authentication headers; use explicit rules

### Cache Cleanup Impact
- GitHub Actions cache sizes reduced by 60-70%
- No impact on build correctness or test coverage
- Faster CI pipeline due to smaller cache transfers
- Reduced storage costs for GitHub Actions artifacts
